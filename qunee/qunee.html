<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>环路演示.html</title>
    <style>
        * {margin: 0;padding: 0}
        .wrapper {
            margin: 10px;
            border: 1px solid #DEDEDE;
            border-radius: 5px;
        }
        .wrapper::before,
        .wrapper::after {
            content: "";
            display: table;
        }
        .wrapper #canvas {
            height: 700px;
            border-radius: 5px;
        }
        .wrapper .control {
            text-align: center;
            line-height: 43px;
            padding: 5px 0;
            border-top: 1px solid #ededed;
        }
        .wrapper .control button {
            font-size: 14px;
            background: #fff;
            border: none;
            border-right: 1px solid #ccc;
            color: #333;
            outline: none;
            padding: 0 5px;
            height: 30px;
            line-height: 30px;
            vertical-align: top;
            cursor: pointer;
        }
        .wrapper .control button:hover {
            background: #ebebeb;
            border-color: #adadad;
        }
        .wrapper .control .btnGroup {
            height: 30px;
            border: 1px solid #ccc;
            display: inline-block;
            margin: 0px 20px;
            border-radius: 5px;
            font-size: 0;
        }
        .wrapper .control .btnGroup button:nth-of-type(1) {
            border-radius: 5px 0 0 5px;
        }
        .wrapper .control .btnGroup button:nth-last-of-type(1) {
            border-radius: 0 5px 5px 0;
            border-right: none;
        }
        .wrapper .control .btnGroup button:disabled {
            background:#bbb;
            cursor: default;
        }
        .Q-Tooltip {
            opacity: .6;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="banner"/> 
            <div id="canvas"></div>
            <div class="control">
                <span class="btnGroup">
                    <button disabled> 请顺序点击按钮  </button>
                    <button id="init">1. 初始化环路</button>
                    <button id="treeLayout">2. 进行树布局 (环路被遮挡)</button>
                </span><br>
                <span class="btnGroup">
                        <button disabled> 请顺序点击按钮  </button>
                        <button id="init1">1. 初始化环路，并设置上下级联动</button>
                        <button id="treeLayout1">2. 进行树布局 (环路被遮挡,且由于上下级联动，极难手动展开)</button>             
                </span>
            </div>
        </div>
    </div>
    
    <script src="http://demo.qunee.com/lib/qunee-min.js"></script>
    <script>
        var graph = new Q.Graph('canvas')

        function init(follow) {
            var A1 = graph.createNode("A", 0, -200)
            var A2 = graph.createNode("B", 0, -100)
            var A3 = graph.createNode("C", -100, 0)
            var A4 = graph.createNode("D", 100, 0)
            var A5 = graph.createNode("E",0, 100)

            graph.createEdge(A1, A2)
            graph.createEdge(A2, A3)
            graph.createEdge(A2, A5)
            graph.createEdge(A4, A2)
            graph.createEdge(A3, A4)
            graph.createEdge(A3, A5)
            graph.createEdge(A4, A5)
           
            var B1 = graph.createNode("F", -500, -100)
            var B2 = graph.createNode("G",-550, 100)
            var B3 = graph.createNode("H",-450, 100)
            graph.createEdge(B1, B2)
            graph.createEdge(B1, B3)
            graph.createEdge(B2, B3)

            graph.createEdge(A3, B1)

            if (follow) {
                 A1.addHost(A2)
                 A2.addHost(A3)
                 A2.addHost(A5)
                 A4.addHost(A2)
                 A3.addHost(A4)
                 A3.addHost(A5)
                 A4.addHost(A5)
                 B1.addHost(B2)
                 B1.addHost(B3)
                 B2.addHost(B3)
                 A3.addHost(B1)
            }

       
        }
        
        var treeLayout = document.getElementById('treeLayout')
        treeLayout.onclick = function(e) {
            var layouter = new Q.TreeLayouter(graph)
            layouter.layoutType = Q.Consts.LAYOUT_TYPE_EVEN_HORIZONTAL
            layouter.doLayout({callback: function(){
                // graph.zoomToOverview()
                graph.moveToCenter()
            }});
        }

        var treeLayout1 = document.getElementById('treeLayout1')
        treeLayout1.onclick = function(e) {
            var layouter = new Q.TreeLayouter(graph)
            layouter.layoutType = Q.Consts.LAYOUT_TYPE_EVEN_HORIZONTAL
            layouter.doLayout({callback: function(){
                // graph.zoomToOverview()
                graph.moveToCenter()
            }});
        }

        graph.moveElements = function(elements, dx, dy){ //移动节点
            elements = findAllFollowers(elements);
            return Q.Graph.prototype.moveElements.call(this, elements, dx, dy);
        }

        function findAllFollowers(elements, map){				//获取所有的跟随节点
            var map = map || new Q.HashList();
            elements.forEach(function(element){
                if(map.contains(element)){
                    return;
                }
                map.add(element);
                if(element.followerList){
                    findAllFollowers(element.followerList, map);
                }
            })
            return map;
		}
        var initBtn = document.getElementById('init')
        initBtn.onclick = function(e) {
            graph.clear()
            init()
            graph.moveToCenter()
        }

        var initBtn1 = document.getElementById('init1')
        initBtn1.onclick = function(e) {
            graph.clear()
            init(true)
            graph.moveToCenter()
        }

        // var refresh = document.getElementById('refresh')
        // refresh.onclick = function(e) {
        //     graph.clear()
        //     init()
        //     // graph.zoomToOverview()
        //     graph.moveToCenter()
        // }

        //添加追随节点
	Q.Node.prototype.addHost = function (host) {
        var followers = this.followerList;
        if (!followers) {
            followers = this.followerList = new Q.HashList();
        }
        followers.add(host);
    };
	
	//移除跟随节点
	Q.Node.prototype.removeHost = function (host) {
        var followers = this.followerList;
        if(followers){
        	followers.remove(host);
        }
    };
	
	//清空追随节点
    Q.Node.prototype.clearHost = function(){
    	var node = this;
    	var followers = node.followerList;
    	if(followers){
	        followers.clear();
	    }
    	node.forEachInEdge(function(e){
    		e.from.removeHost(node);
    	});
    };





var TableUI = function (data) {
    Q.doSuperConstructor(this, TableUI, arguments);
}
TableUI.prototype = {
    cellWidth: 80,
    cellHeight: 25,
    measure: function () {
        if (!this.data) {
            this.setMeasuredBounds(0, 0);
            return;
        }
        var width = 0, height = 0;
        if (this.data.header) {
            height += this.cellHeight;
            width = this.data.header.length * this.cellWidth;
        }
        if (this.data.data && this.data.data.length) {
            var rows = this.data.data.length;
            height += rows * this.cellHeight;
            if (!width) {
                width = this.data.data[0].length * this.cellWidth;
            }
        }
        this.setMeasuredBounds(width, height);
    },
    drawCell: function (g, x, y, background, align, color, content) {
        var text;
        if (content instanceof Object && !Q.isString(content)) {
            text = '' + content.text;
            color = content.color || color;
            align = content.align || align;
        } else {
            text = '' + content;
        }
        var cellWidth = this.cellWidth, cellHeight = this.cellHeight;
        if (background) {
            g.fillStyle = background;
            g.fillRect(x, y, cellWidth, cellHeight);
            g.strokeStyle = '#FFF';
            g.strokeRect(x, y, cellWidth, cellHeight);
        }
        if (align) {
            if(align == 'center'){
                x += cellWidth / 2;
            }else if(align == 'right'){
                x += cellWidth;
            }
            g.textAlign = align;
        }
        g.textBaseline = 'middle';
        g.fillStyle = color;
        g.fillText(text, x, y + cellHeight / 2);
    },
    draw: function (g, scale, selected) {
        if (!this.data) {
            return;
        }
        g.fillStyle = '#EEE';
        g.fillRect(0, 0, this.originalBounds.width, this.originalBounds.height);

        var header = this.data.header;
        var data = this.data.data;

        var x = 0, y = 0;
        var cellWidth = this.cellWidth, cellHeight = this.cellHeight;
        if (header) {
            header.forEach(function (name) {
                this.drawCell(g, x, y, '#597EB5', 'center', '#FFF', name);
                x += cellWidth;
            }.bind(this))
            y+= cellHeight;
        }
        if(data){
            data.forEach(function(row, index){
                x = 0;
                var background = index % 2 ? '#EAEDF4' : '#CAD0DF';
                row.forEach(function (name) {
                    this.drawCell(g, x, y, background, 'center', '#555', name);
                    x += cellWidth;
                }.bind(this))
                y+= cellHeight;
            }.bind(this));
        }
    }
}
		Q.extend(TableUI, Q.BaseUI);
		var hello = graph.createNode("Hello", -100, -50);
		hello.image = Q.Graphs.server;
		var qunee = graph.createNode("Qunee", 100, 50);

		var edges = graph.createEdge(hello, qunee)
		edges.flag = 't'
		var tableUI = new TableUI();
		tableUI.position = Q.Position.CENTER_TOP;
		tableUI.anchorPosition = Q.Position.CENTER_BOTTOM;
		tableUI.offsetY = -10;
		tableUI.showPointer = true;
		tableUI.backgroundColor = '#EAEDF4';
		tableUI.borderRadius = 0;
		edges.addUI(tableUI, {
		    property: 'tableData',
		    propertyType: Q.Consts.PROPERTY_TYPE_CLIENT,
		    bindingProperty: "data"
		})
		edges.tableUI = tableUI;
	



graph.addCustomInteraction({
    onstart: function(evt, graph){
        Q.log("start");
    },
    onmousemove: function(evt, graph){
    	// Q.log("mousemove");
        // var ui = graph.getUIByMouseEvent(evt);
        // console.log(ui)
        var n = graph.getElementByMouseEvent(evt);
        if (n && n.flag === 't') {
        	 	edges.set('tableData', {
				    header: ['ID', 'Project', 'Value'], data: [
				        ['1', 'Temperature', {text: '24°C', color: '#FF0'}],
				        ['2', 'Humidity', {text: '56%', color: '#F00'}],
				        ['3', 'Air Volume', '52.0CMH'],
				    ]
				});
        } else {
				edges.set('tableData', {

				});
        }
       
        // if(!ui){
        //     graph.cursor = null;
        //     highlight(null);
        //     return;
        // }
        // graph.cursor = "pointer";
        // highlight(ui.data);
        // if(ui.data == colorShape){
        //     graph.cursor = "crosshair";
        //     var point = graph.toLogical(evt);
        //     var uiBounds = graph.getUIBounds(ui);
        //     var left = uiBounds.x;
        //     var top = uiBounds.y;
        //     var r = parseInt(255 * (point.x - left) / uiBounds.width);
        //     var g = parseInt(255 * (point.y - top) / uiBounds.height);
        //     colorShape.setStyle(Q.Styles.SHAPE_FILL_COLOR, "rgb(" + r + "," + g + ", 255)");
        //     return;
        // }
    },
    onrelease: function(evt, graph){
        Q.log("release");
    },
    onmousewheel: function(evt, graph){
        Q.log("mousewheel - " + evt.delta);
    },
    onkeydown: function(evt, graph){
        Q.log("keydown");
    },
    onclick: function(evt, graph){
        Q.log("click");
        // var ui = graph.getUIByMouseEvent(evt);
        // if(ui && ui.data.clickable){
        //     alert("Clicked at - '" + ui.data.name + "'");
        // }
    },
    ondblclick: function(evt, graph){
        Q.log("dblclick");
        // var ui = graph.getUIByMouseEvent(evt);
        // if(ui && ui.data.dblclickable){
        //     alert("Double Clicked at - '" + ui.data.name + "'");
        // }
    },
    onlongpress: function(evt, graph){
        Q.log("hold");
    }
});
    </script>
</body>
</html>
